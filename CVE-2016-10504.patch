From b8f4d7720e006626fff8b9a3858be6ee56d41fab Mon Sep 17 00:00:00 2001
From: Even Rouault <even.rouault@spatialys.com>
Date: Wed, 28 Aug 2019 20:47:21 -0700
Subject: [PATCH] Fix write heap buffer overflow in opj_mqc_byteout().

Discovered by Ke Liu of Tencent's Xuanwu LAB (#835)
---
 pdfium/third_party/libopenjpeg20/tcd.c | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/pdfium/third_party/libopenjpeg20/tcd.c b/pdfium/third_party/libopenjpeg20/tcd.c
index 673633c..217b2c0 100644
--- a/pdfium/third_party/libopenjpeg20/tcd.c
+++ b/pdfium/third_party/libopenjpeg20/tcd.c
@@ -1086,6 +1086,10 @@ static OPJ_BOOL opj_tcd_code_block_enc_allocate_data (opj_tcd_cblk_enc_t * p_cod
 	
 	l_data_size = (OPJ_UINT32)((p_code_block->x1 - p_code_block->x0) * (p_code_block->y1 - p_code_block->y0) * (OPJ_INT32)sizeof(OPJ_UINT32));
 	
+    /* The +1 is needed for https://github.com/uclouvain/openjpeg/issues/835 */
+    l_data_size = 1 + (OPJ_UINT32)((p_code_block->x1 - p_code_block->x0) *
+                                   (p_code_block->y1 - p_code_block->y0) * (OPJ_INT32)sizeof(OPJ_UINT32));
+
 	if (l_data_size > p_code_block->data_size) {
 		if (p_code_block->data) {
 			opj_free(p_code_block->data - 1); /* again, why -1 */
-- 
2.23.0

