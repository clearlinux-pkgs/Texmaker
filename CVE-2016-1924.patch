From 58a0a6f235c98ca4778a11a09f52e78e59435bd1 Mon Sep 17 00:00:00 2001
From: mayeut <mayeut@users.noreply.github.com>
Date: Wed, 28 Aug 2019 22:11:55 -0700
Subject: [PATCH] Fix Out-of-Bounds Access in function opj_tgt_reset

---
 pdfium/third_party/libopenjpeg20/j2k.c | 3 +++
 pdfium/third_party/libopenjpeg20/t2.c  | 8 ++++++--
 2 files changed, 9 insertions(+), 2 deletions(-)

diff --git a/pdfium/third_party/libopenjpeg20/j2k.c b/pdfium/third_party/libopenjpeg20/j2k.c
index b5f6fe9..7d95e38 100644
--- a/pdfium/third_party/libopenjpeg20/j2k.c
+++ b/pdfium/third_party/libopenjpeg20/j2k.c
@@ -8791,6 +8791,9 @@ static OPJ_BOOL opj_j2k_read_SPCod_SPCoc(  opj_j2k_t *p_j2k,
 
         opj_read_bytes(l_current_ptr,&l_tccp->cblksty ,1);              /* SPcoc (G) */
         ++l_current_ptr;
+        if (l_tccp->cblksty & 0xC0U) { /* 2 msb are reserved, assume we can't read */
+                return OPJ_FALSE;
+        }
 
         opj_read_bytes(l_current_ptr,&l_tccp->qmfbid ,1);               /* SPcoc (H) */
         ++l_current_ptr;
diff --git a/pdfium/third_party/libopenjpeg20/t2.c b/pdfium/third_party/libopenjpeg20/t2.c
index 5af1a69..a3bc476 100644
--- a/pdfium/third_party/libopenjpeg20/t2.c
+++ b/pdfium/third_party/libopenjpeg20/t2.c
@@ -868,9 +868,13 @@ static OPJ_BOOL opj_t2_read_packet_header( opj_t2_t* p_t2,
 
                 /* reset tagtrees */
                 for (bandno = 0; bandno < l_res->numbands; ++bandno) {
-                        opj_tcd_precinct_t *l_prc = &l_band->precincts[p_pi->precno];
-
                         if ( ! ((l_band->x1-l_band->x0 == 0)||(l_band->y1-l_band->y0 == 0)) ) {
+                                opj_tcd_precinct_t *l_prc = &l_band->precincts[p_pi->precno];
+                                if (!(p_pi->precno < (l_band->precincts_data_size / sizeof(opj_tcd_precinct_t)))) {
+                                        return OPJ_FALSE;
+                                }
+													
+													
                                 opj_tgt_reset(l_prc->incltree);
                                 opj_tgt_reset(l_prc->imsbtree);
                                 l_cblk = l_prc->cblks.dec;
-- 
2.23.0

