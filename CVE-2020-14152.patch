From ab53c15a2bfb73c0941cfa1e446960077904801c Mon Sep 17 00:00:00 2001
From: Mark D Horn <mark.d.horn@intel.com>
Date: Thu, 22 Oct 2020 18:25:46 -0700
Subject: [PATCH] Honor max_memory_to_use/JPEGMEM/-maxmemory

Fixes CVE-2020-14152

Inspired by:
https://github.com/libjpeg-turbo/libjpeg-turbo/commit/da2a27ef056a0179cbd80f9146e58b89403d9933

Signed-off-by: Mark D Horn <mark.d.horn@intel.com>
---
 pdfium/third_party/libjpeg/fpdfapi_jmemnobs.c | 10 +++++++++-
 1 file changed, 9 insertions(+), 1 deletion(-)

diff --git a/pdfium/third_party/libjpeg/fpdfapi_jmemnobs.c b/pdfium/third_party/libjpeg/fpdfapi_jmemnobs.c
index 0344f6fd7387..f06d64208a3d 100644
--- a/pdfium/third_party/libjpeg/fpdfapi_jmemnobs.c
+++ b/pdfium/third_party/libjpeg/fpdfapi_jmemnobs.c
@@ -79,7 +79,15 @@ GLOBAL(long)
 jpeg_mem_available (j_common_ptr cinfo, long min_bytes_needed,
 		    long max_bytes_needed, long already_allocated)
 {
-  return max_bytes_needed;
+  if (cinfo->mem->max_memory_to_use) {
+    if (cinfo->mem->max_memory_to_use > already_allocated)
+      return cinfo->mem->max_memory_to_use - already_allocated;
+    else
+      return 0;
+  } else {
+    /* Here we always say, "we got all you want bud!" */
+    return max_bytes_needed;
+  }
 }
 
 
-- 
2.29.0

